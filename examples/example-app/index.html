<html>
  <head>
    <style>
      body {
        font-family: 'Arial', 'Helvetica', 'sans-serif'
      }
      textarea {
        width: 100%;
        height:300px;
      }
      #buttons {
        margin-top: 10px;
      }
    </style>
    <script src="jiff_bundled.js"></script>
    <script type="text/javascript">
      var cfmClient,
          lastSavedContent;

      function newFile() {
        cfmClient && cfmClient.newFileDialog();
      }

      function openFile() {
        // no callback for open - we will handle it in the clientInit event callback
        cfmClient && cfmClient.openFileDialog();
      }

      function saveFile() {
        cfmClient && cfmClient.save();
      }

      function saveFileAs() {
        cfmClient && cfmClient.saveFileAsDialog(getTextValue());
      }

      function getTextValue() {
        return document.getElementById("text").value;
      }

      function setTextValue(text) {
        document.getElementById("text").value = text;
      }

      function setClient(client) {
        cfmClient = client;
      }

      function changed() {
        cfmClient.dirty();
      }

      function focus() {
        document.getElementById("text").focus();
      }

      function setSavedContent(content) {
        lastSavedContent = content;
      }

      function getPatchValue() {
        try {
          var oldDoc = JSON.parse(lastSavedContent),
              newDoc = JSON.parse(getTextValue()),
              diff   = jiff.diff(oldDoc, newDoc);
          return JSON.stringify(diff);
        } catch (e) {
          return null;
        }
      }
    </script>
  </head>
  <body>
    <h2>Demo App</h2>
    <p>
      This simple demo app uses the textarea below to edit text files.  You can either use the menu bar or the buttons below to open, save and create new files.
    </p>
    <div>
      <textarea cols="50" rows="10" id="text" onkeyup="changed()"></textarea>
    </div>
    <div id="buttons">
      <button onclick="newFile()">New</button>
      <button onclick="openFile()">Open</button>
      <button onclick="saveFile()">Save</button>
      <button onclick="saveFileAs()">Save As</button>
    </div>
    <script type="text/javascript">
      var cfm = parent && parent.CloudFileManager ? parent.CloudFileManager : null,
          clientOptions;

      if (cfm) {
        cfm.clientConnect(function (event) {
          console.log(event);
          switch (event.type) {
            case 'connected':
              var client = event.data.client;
              setClient(client);
              client.appendMenuItem({
                name: 'Inner Frame Callback Menu Item',
                action: function () { alert('This is an example of a callback menu item added in the inner frame')}
              });
              //client.setMenuBarInfo('Version 0.0.1');
              break;

            case 'getContent':
              if (event.data.patchable && (patch = getPatchValue())) {
                event.callback(patch, true);
              } else {
                event.callback(getTextValue());
              }
              break;

            case 'newedFile':
              setTextValue('');
              setSavedContent(null);
              focus();
              break;

            case 'openedFile':
              setTextValue(event.data.content);
              setSavedContent(event.data.content);
              focus();
              break;

            case 'savedFile':
              setSavedContent(event.data.content);
              break;
          }
        });
      }

      document.getElementById("text").focus()
    </script>
  </body>
</html>
